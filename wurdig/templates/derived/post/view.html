<%inherit file="/base/master.html"/>
<%namespace file="comment_fields.html" name="fields" import="*"/>
<%namespace file="/component/posts.html" name="posts" import="*"/>

<%def name="title()">${parent.title()} &gt; ${c.post.title}</%def>
<%def name="ps_feeds()">
    ${h.auto_discovery_link(
        h.url_for(
            controller='comment', 
            action='post_comment_feed', 
            post_id=unicode(c.post.id)
        ), 
        feed_type='atom', 
        title='Recent Comments for "' + c.post.title + '"'
    )}
</%def>

<h2>${c.post.title}</h2>

<div class="wurdig-entry">
    ${h.literal(c.post.content)}
        
    <p class="wurdig-entry-meta">
        ${posts.tag_list(c.post.tags)}
        % if h.auth.authorized(h.auth.is_valid_user):
            <span class="wurdig-admin">
                <strong>Admin</strong> : 
                ${h.link_to(
                    'Edit This Post',
                    h.url_for(controller='post', action='edit', id=unicode(c.post.id))
                )}
            </span>
        % endif
    </p>
    
    % if not c.post.comments_allowed and len(c.post.comments) > 20:
        <p class="wurdig-comment-notice">Comments have been disabled for this post.</p>
    % endif
    
    % if len(c.post.comments):
        <div id="comments">
            <h3>${h.plural(len(c.post.comments), 'Comment', 'Comments')} for "${c.post.title}"</h3>
            
            <%
                import hashlib
            %>
            
            % for k,comment in enumerate(c.post.comments):
                <div id="comment-${comment.id}">
                    <h4>
                        <strong>${str(k+1)}</strong>
                        <em><img src="http://www.gravatar.com/avatar/${hashlib.md5(comment.email).hexdigest()}?s=80" alt="${comment.name} - Gravatar"></em>
                        <cite>
                            % if comment.url not in ['', u'', None]:
                                <a href="${comment.url}">${comment.name}</a>
                            % else:
                                ${comment.name}
                            % endif
                        </cite>
                    </h4>
                    <blockquote>
                        ${h.literal(comment.content)}
                        <p class="wurdig-comment-posted">
                            ${comment.created_on}
                            <a href="#comment-${comment.id}">Link</a>
                        </p>
                    </blockquote>
                </div>
            % endfor
        </div>
    % endif
    
    % if c.post.comments_allowed:
        <div id="leave-comment">
            ${h.secure_form(h.url_for(post_id=c.post.id, controller='comment', action='create'), method='post')}
                ${fields.body()}
                ${h.submit('create_comment', 'Create Comment')}
            ${h.end_form()}
        </div>
    % else:
        <p class="wurdig-comment-notice">Comments have been disabled for this post.</p>
    % endif
</div>